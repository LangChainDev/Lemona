# Lemona

DB catalog exporter in SQLAlchemy form.


Lemona is a tool that can make DB version management more convenient with alembic.

Lemona supports migration of each database using sqlalchemy's metadata.



## Dependency

- python3.6 

- sqlalchemy

- alembic(optional)




## How to use

Go to the directory where you want to run alembic version control and execute the following command.

I created a project name as alembic for explanation. You can create it with the name you want.
```shell
$ alembic init myproject 
```


Now, the alembic version control project is created with the following directory structure.
<!-- AUTO-GENERATED-CONTENT:START (DIRTREE:dir=./) -->

```
myproject-directory-tree/
├── alembic.ini
  └── myproject
    └── versions
    └── env.py
    └── README
    └── script.py.mako
```

<!-- AUTO-GENERATED-CONTENT:END -->


After creating myproject, you can see the following in the ```env.py``` file. You should put the information corresponding to the database model.

In this example, we use the sqlalchemy's metadata to get schema information.
```python
# env.py
# 
# ...
# 
# add your model's MetaData object here
# for 'autogenerate' support
# target_metadata = None
import sys
sys.path.append('../Lemona')
import meta_model
target_metadata = meta_model.DevBase.metadata
# 
# ...
# 
```


### ※ Importance 
You must execute the command with the name <bold>`"initial_migraion"`<bold>.
If you do not naming like this, you can not parse the sequence part of postgresql properly.


In the `alembic.ini` file, put the url of the database to be version controlled as alembic.

```shell
# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

sqlalchemy.url = driver://user:pass@localhost/dbname
```



In the `alembic/env.py` file, put the url of the database to copy.

```
from sqlalchemy import create_engine, MetaData
from sqlalchemy.ext.declarative import declarative_base

#: set schema to copy(already created schema)
url = 'driver://user:pass@localhost/dbname'

engine = create_engine(url)
conn = engine.connect()
Base = declarative_base(metadata=MetaData(bind=engine))
Base.metadata.reflect(engine)

target_metadata = Base.metadata
```



Execute Alembic command.

```shell
$ alembic revision --autogenerate -m "initial_migration"
```

>  **Importance**
>
> You must execute the command with the name <bold>`"initial_migraion"`<bold>.
>
> If you do not naming like this, you can not parse the sequence part of postgresql properly.

You can see new revision file in `alembic/versions/`.



Now you can run the migration code generated by alembic with the following command.

```shell
$ alembic upgrade head
```



#### More Info

sqlAlchemy : http://alembic.zzzcomputing.com/en/latest/

Alembic : https://www.sqlalchemy.org/
